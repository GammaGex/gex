<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Processador de Dados</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .bg-slate-800-contrast {
            background-color: #1e293b;
        }
        .text-slate-200-contrast {
            color: #e2e8f0;
        }
        .placeholder-slate-500-contrast::placeholder {
            color: #64748b;
        }
        #fieldsCheckboxesContainer, #ratiosInputContainer, #txtConfigContainer {
            max-height: 150px; 
            overflow-y: auto;
            border: 1px solid #334155; 
            padding: 0.75rem; 
            border-radius: 0.5rem; 
            background-color: #334155; 
        }
        .checkbox-label {
            display: block; 
            margin-bottom: 0.5rem; 
            color: #cbd5e1; 
            cursor: pointer;
        }
        .checkbox-label input[type="checkbox"] {
            margin-right: 0.5rem;
            accent-color: #0ea5e9; 
        }
        
        .ratio-item-label, .txt-config-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem; 
            color: #cbd5e1; 
        }
        .ratio-item-label input[type="checkbox"], .txt-config-item .original-field-name {
            margin-right: 0.75rem;
            accent-color: #0ea5e9;
            flex-shrink: 0;
        }
        .ratio-item-label .ratio-ticker-name, .txt-config-item .original-field-name {
            width: 130px; 
            margin-right: 0.5rem;
            flex-shrink: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 0.875rem;
        }
         .txt-config-item .original-field-name {
            font-weight: 500;
         }

        .ratio-item-label input[type="number"], 
        .txt-config-item input[type="text"], 
        .txt-config-item .txt-num-input {
            width: 150px; 
            padding: 0.35rem 0.5rem;
            border-radius: 0.25rem;
            background-color: #475569; 
            color: #e2e8f0; 
            border: 1px solid #64748b; 
            flex-shrink: 0;
            font-size: 0.875rem;
            margin-right: 0.5rem;
        }
        .txt-config-item .txt-num-input {
             width: 100px;
        }
        .ratio-item-label input[type="number"]:disabled {
            background-color: #334155;
            color: #64748b;
            cursor: not-allowed;
        }
        .config-button { 
            background-color: #6366f1; 
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }
        .config-button:hover {
            background-color: #4f46e5; 
        }
        #fileUploadConfig {
            display: none; 
        }
        .auto-ratio-section {
            border-top: 1px solid #475569;
            margin-top: 1rem;
            padding-top: 1rem;
        }
        .calc-button:disabled {
            background-color: #475569;
            cursor: not-allowed;
        }

    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-slate-900 text-slate-100 flex flex-col items-center justify-center min-h-screen p-4 selection:bg-sky-500 selection:text-white">

    <!-- Tela de Login -->
    <div id="loginOverlay" class="fixed inset-0 bg-slate-900 bg-opacity-95 flex items-center justify-center z-50">
        <div class="bg-slate-800 p-8 rounded-xl shadow-2xl w-full max-w-sm relative">
            <!-- Seletor de Idioma -->
            <div class="absolute top-4 right-4 flex gap-3">
                <button data-lang="pt" class="lang-button">
                    <img src="https://flagcdn.com/w20/br.png" alt="Português">
                </button>
                <button data-lang="en" class="lang-button">
                    <img src="https://flagcdn.com/w20/us.png" alt="English">
                </button>
            </div>
            <h2 class="text-2xl font-bold text-sky-400 text-center mb-6" data-i18n-key="loginTitle">Login</h2>
            <div class="space-y-4">
                <div>
                    <label for="username" class="block text-sm font-medium text-slate-300 mb-1" data-i18n-key="usernameLabel">Usuário</label>
                    <input type="text" id="username" class="w-full p-3 bg-slate-700 text-slate-200 border border-slate-600 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-slate-300 mb-1" data-i18n-key="passwordLabel">Senha</label>
                    <input type="password" id="password" class="w-full p-3 bg-slate-700 text-slate-200 border border-slate-600 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
                </div>
            </div>
            <p id="loginError" class="text-red-400 text-sm text-center h-5 mt-4"></p>
            <button id="loginButton" class="w-full mt-4 bg-sky-500 hover:bg-sky-600 text-white font-semibold py-3 rounded-lg shadow-md transform hover:scale-105 transition-all" data-i18n-key="loginButton">Entrar</button>
        </div>
    </div>

    <!-- Modal de Confirmação para Deletar Arquivos Antigos -->
    <div id="confirmDeleteModal" class="hidden fixed inset-0 bg-slate-900 bg-opacity-80 flex items-center justify-center z-50 p-4">
        <div class="bg-slate-800 p-8 rounded-xl shadow-2xl w-full max-w-lg text-center">
            <h2 class="text-3xl font-bold text-red-500 mb-4" data-i18n-key="attention">ATENÇÃO!</h2>
            <p class="text-lg text-slate-200 mb-2" data-i18n-key="deleteWarning">
                É essencial <strong class="font-bold text-yellow-300" data-i18n-key="delete">DELETAR OS ARQUIVOS ANTIGOS</strong> da pasta antes de fazer o download dos novos.
            </p>
            <p class="text-sm text-slate-400 mb-8" data-i18n-key="deleteReason">
                Isso garante que seu programa de plotagem leia apenas os dados mais recentes, evitando erros.
            </p>
            <div class="flex justify-center gap-4">
                <button id="cancelDownloadButton" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition-all" data-i18n-key="cancel">Cancelar</button>
                <button id="confirmDownloadButton" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-8 rounded-lg shadow-md transition-all" data-i18n-key="confirmDelete">Sim, já deletei. Prosseguir.</button>
            </div>
        </div>
    </div>
    
    <!-- Container Principal do Aplicativo (inicialmente oculto) -->
    <div id="appContainer" class="hidden bg-slate-800-contrast p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-3xl">
        <header class="mb-6 sm:mb-8 text-center">
            <h1 class="text-2xl sm:text-3xl font-bold text-sky-400" data-i18n-key="appTitle">Processador de Dados Gex</h1>
            <p class="text-sm text-slate-400 mt-1" data-i18n-key="appSubtitle">Cole os dados, analise, defina ratios, configure e gere arquivos TXT.</p>
        </header>

        <main>
            <div class="mb-6 p-4 bg-slate-700 rounded-lg">
                <h2 class="text-lg font-semibold text-sky-300 mb-3 text-center" data-i18n-key="configTitle">Gerenciamento de Configurações</h2>
                <div class="flex flex-col sm:flex-row justify-center items-center gap-3">
                    <button id="loadConfigButton" class="config-button text-white font-semibold py-2 px-4 rounded-lg shadow-md transform hover:scale-105 transition-all w-full sm:w-auto" data-i18n-key="loadConfig">Carregar Configurações</button>
                    <input type="file" id="fileUploadConfig" accept=".json">
                    <button id="saveConfigButton" class="config-button text-white font-semibold py-2 px-4 rounded-lg shadow-md transform hover:scale-105 transition-all w-full sm:w-auto" data-i18n-key="saveConfig">Salvar Configurações Atuais</button>
                </div>
                <p id="configStatusMessage" class="text-xs text-slate-400 mt-2 text-center"></p>
            </div>

            <div class="mb-4">
                <label for="rawData" class="block text-sm font-medium text-slate-300 mb-1" data-i18n-key="rawDataLabel">Dados:</label>
                <textarea id="rawData" rows="4" class="w-full p-3 bg-slate-700 text-slate-200-contrast border border-slate-600 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 placeholder-slate-500-contrast"></textarea>
            </div>

            <div class="mb-4 text-center">
                <button id="analyzeFieldsButton" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transform hover:scale-105 transition-all" data-i18n-key="analyzeButton">Analisar Dados</button>
            </div>
            
            <div id="fieldsSelectionSection" class="mb-4 hidden">
                <label class="block text-sm font-medium text-slate-300 mb-2" data-i18n-key="step1Title">1. Selecione os campos que deseja manter:</label>
                <div id="fieldsCheckboxesContainer"></div>
                <div class="mt-2 text-right">
                     <button id="selectAllFields" class="text-xs text-sky-400 hover:text-sky-300 mr-2" data-i18n-key="selectAll">Selecionar Todos</button>
                     <button id="deselectAllFields" class="text-xs text-sky-400 hover:text-sky-300" data-i18n-key="deselectAll">Desselecionar Todos</button>
                </div>
            </div>

            <div id="ratiosSection" class="mb-4 hidden">
                <label class="block text-sm font-medium text-slate-300 mb-2" data-i18n-key="step2Title">2. Para aplicar ratio, marque o ativo e defina o valor:</label>
                <div id="ratiosInputContainer"></div>
                <!-- Seção para Cálculo Automático Simplificada -->
                <div class="auto-ratio-section">
                    <h3 class="text-base font-medium text-slate-200 mb-3 text-center" data-i18n-key="autoRatioTitle">Cálculo de Ratio Automático (Yahoo Finance)</h3>
                    <div class="text-center">
                        <button id="calculateAllRatiosButton" class="calc-button bg-teal-500 hover:bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transform hover:scale-105 transition-all" disabled data-i18n-key="calculateAllRatios">Calcular Todos os Ratios</button>
                    </div>
                     <p id="ratioCalcStatus" class="text-center text-xs text-yellow-300 h-4 mt-2"></p>
                </div>
            </div>

            <div id="generateOutputButtonContainer" class="mb-4 text-center hidden">
                <button id="generateOutputButton" class="bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md transform hover:scale-105 transition-all" data-i18n-key="generateOutput">Gerar Saída Processada</button>
            </div>

            <div id="processedDataSection" class="mb-4 hidden">
                <label for="processedData" class="block text-sm font-medium text-slate-300 mb-1" data-i18n-key="processedDataLabel">Dados Processados (Prévia):</label>
                <textarea id="processedData" rows="4" class="w-full p-3 bg-slate-700 text-slate-200-contrast border border-slate-600 rounded-lg readonly" readonly></textarea>
            </div>
            
            <div id="configureTxtButtonContainer" class="mb-4 text-center hidden">
                <button id="configureTxtButton" class="bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md transform hover:scale-105 transition-all" data-i18n-key="configureTxt">Configurar e Gerar Arquivos TXT</button>
            </div>

            <div id="txtConfigurationSection" class="mb-4 hidden">
                <label class="block text-sm font-medium text-slate-300 mb-2" data-i18n-key="step3Title">3. Configure os Nomes dos Campos para os Arquivos TXT:</label>
                <div id="txtConfigContainer"></div>
                 <div class="mt-3 text-center">
                    <button id="downloadTxtFilesButton" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transform hover:scale-105 transition-all mr-2 mb-2" data-i18n-key="downloadIndividual">Baixar Arquivos TXT Individuais</button>
                </div>
            </div>
            <div id="downloadLinksArea" class="mt-4 text-sm"></div>

        </main>
        <footer class="mt-8 text-center"><p class="text-xs text-slate-500" data-i18n-key="footer">Processador de Dados Gex</p></footer>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- INÍCIO DA SEÇÃO DE TRADUÇÃO (I18N) ---
        const translations = {
            en: {
                loginTitle: "Login",
                usernameLabel: "User",
                passwordLabel: "Password",
                loginButton: "Sign In",
                loginError: "Invalid username or password.",
                appTitle: "Gex Data Processor",
                appSubtitle: "Paste data, analyze, set ratios, configure, and generate TXT files.",
                configTitle: "Settings Management",
                loadConfig: "Load Settings",
                saveConfig: "Save Current Settings",
                rawDataLabel: "Data:",
                analyzeButton: "Analyze Data",
                step1Title: "1. Select the fields to keep:",
                selectAll: "Select All",
                deselectAll: "Deselect All",
                step2Title: "2. To apply a ratio, check the asset and set the value:",
                autoRatioTitle: "Automatic Ratio Calculation (Yahoo Finance)",
                calculateAllRatios: "Calculate All Ratios",
                generateOutput: "Generate Processed Output",
                processedDataLabel: "Processed Data (Preview):",
                configureTxt: "Configure and Generate TXT Files",
                step3Title: "3. Configure Field Names for TXT Files:",
                downloadIndividual: "Download Individual TXT Files",
                footer: "Gex Data Processor",
                attention: "ATTENTION!",
                deleteWarning: "It is essential to <strong class='font-bold text-yellow-300'>DELETE THE OLD FILES</strong> from the folder before downloading the new ones.",
                deleteReason: "This ensures your plotting program reads only the latest data, avoiding errors.",
                cancel: "Cancel",
                confirmDelete: "Yes, I've deleted them. Proceed.",
                configLoaded: `Configuration "{0}" loaded. Click "Analyze Data" to apply it.`,
                configSaved: `Current settings saved to {0}`,
                noValidData: "No valid data (ticker or field) found.",
                noFieldsFound: "No data fields (e.g., Call Resistance, HVL) found, only tickers.",
                noTickersForRatio: "No tickers available to set ratios (after exclusions).",
                analysisDone: "Analysis complete. Define your settings.",
                analysisDoneConfigLoaded: "Loaded configuration applied. For ratios, click the calculation button.",
                noDataToProcess: "No data to process.",
                noFieldsSelectedForTxt: "No fields were selected in Step 1 to configure for TXT.",
                noDataForTxt: "No processed data to generate TXT files.",
                noFilesGenerated: "No TXT files generated. Check settings and processed data.",
                statusFetching: "Fetching prices...",
                statusCalculatingVs: "Calculating vs {0}...",
                statusDone: "All calculations complete!",
                statusFailRef: "Failed to fetch reference price for {0}.",
                statusFailTicker: "Failed to fetch price for {0}.",
                statusInvalidPrice: "Invalid price for {0}."
            },
            pt: {
                loginTitle: "Login",
                usernameLabel: "Usuário",
                passwordLabel: "Senha",
                loginButton: "Entrar",
                loginError: "Usuário ou senha inválidos.",
                appTitle: "Processador de Dados Gex",
                appSubtitle: "Cole os dados, analise, defina ratios, configure e gere arquivos TXT.",
                configTitle: "Gerenciamento de Configurações",
                loadConfig: "Carregar Configurações",
                saveConfig: "Salvar Configurações Atuais",
                rawDataLabel: "Dados:",
                analyzeButton: "Analisar Dados",
                step1Title: "1. Selecione os campos que deseja manter:",
                selectAll: "Selecionar Todos",
                deselectAll: "Desselecionar Todos",
                step2Title: "2. Para aplicar ratio, marque o ativo e defina o valor:",
                autoRatioTitle: "Cálculo de Ratio Automático (Yahoo Finance)",
                calculateAllRatios: "Calcular Todos os Ratios",
                generateOutput: "Gerar Saída Processada",
                processedDataLabel: "Dados Processados (Prévia):",
                configureTxt: "Configurar e Gerar Arquivos TXT",
                step3Title: "3. Configure os Nomes dos Campos para os Arquivos TXT:",
                downloadIndividual: "Baixar Arquivos TXT Individuais",
                footer: "Processador de Dados Gex",
                attention: "ATENÇÃO!",
                deleteWarning: "É essencial <strong class='font-bold text-yellow-300'>DELETAR OS ARQUIVOS ANTIGOS</strong> da pasta antes de fazer o download dos novos.",
                deleteReason: "Isso garante que seu programa de plotagem leia apenas os dados mais recentes, evitando erros.",
                cancel: "Cancelar",
                confirmDelete: "Sim, já deletei. Prosseguir.",
                configLoaded: `Configuração "{0}" carregada. Clique em "Analisar Dados" para aplicá-la.`,
                configSaved: `Configurações atuais salvas em {0}`,
                noValidData: "Nenhum dado válido (ticker ou campo) encontrado.",
                noFieldsFound: "Nenhum campo de dados (ex: Call Resistance, HVL) encontrado, apenas tickers.",
                noTickersForRatio: "Nenhum ticker para definir ratios (após exclusões).",
                analysisDone: "Análise concluída. Defina suas configurações.",
                analysisDoneConfigLoaded: "Configuração carregada aplicada. Para os ratios, clique no botão de cálculo.",
                noDataToProcess: "Nenhum dado para processar.",
                noFieldsSelectedForTxt: "Nenhum campo foi selecionado na Etapa 1 para configurar para TXT.",
                noDataForTxt: "Nenhum dado processado para gerar arquivos TXT.",
                noFilesGenerated: "Nenhum arquivo TXT gerado. Verifique as configurações e os dados processados.",
                statusFetching: "Buscando preços...",
                statusCalculatingVs: "Calculando vs {0}...",
                statusDone: "Todos os cálculos concluídos!",
                statusFailRef: "Falha ao buscar preço de referência para {0}.",
                statusFailTicker: "Falha ao buscar preço para {0}.",
                statusInvalidPrice: "Preço inválido para {0}."
            }
        };

        let currentLanguage = 'pt'; // Default language

        function setLanguage(lang) {
            currentLanguage = lang;
            document.documentElement.lang = lang;
            document.querySelectorAll('[data-i18n-key]').forEach(element => {
                const key = element.getAttribute('data-i18n-key');
                if (translations[lang] && translations[lang][key]) {
                    // Use innerHTML to allow for strong tags in translations
                    element.innerHTML = translations[lang][key];
                }
            });
             document.querySelectorAll('[data-i18n-placeholder-key]').forEach(element => {
                const key = element.getAttribute('data-i18n-placeholder-key');
                if (translations[lang] && translations[lang][key]) {
                    element.placeholder = translations[lang][key];
                }
            });

            // Update language switcher visual state
            document.querySelectorAll('.lang-button').forEach(btn => {
                if (btn.dataset.lang === lang) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        document.querySelectorAll('.lang-button').forEach(button => {
            button.addEventListener('click', () => {
                setLanguage(button.dataset.lang);
            });
        });

        // Initialize with default language
        setLanguage('pt');
        // --- FIM DA SEÇÃO DE TRADUÇÃO ---


        // ---- INÍCIO DA SEÇÃO DE LOGIN ----
        const loginOverlay = document.getElementById('loginOverlay');
        const appContainer = document.getElementById('appContainer');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const loginButton = document.getElementById('loginButton');
        const loginError = document.getElementById('loginError');

        // --- Altere o usuário e a senha aqui ---
        const correctUser = "GEX";
        const correctPass = "GEX"; 

        function attemptLogin() {
            const user = usernameInput.value;
            const pass = passwordInput.value;

            if (user === correctUser && pass === correctPass) {
                // Sucesso
                loginOverlay.classList.add('hidden');
                appContainer.classList.remove('hidden');
            } else {
                // Falha
                loginError.textContent = translations[currentLanguage].loginError;
                setTimeout(() => {
                    loginError.textContent = "";
                }, 3000);
            }
        }

        loginButton.addEventListener('click', attemptLogin);
        passwordInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') {
                attemptLogin();
            }
        });
        // ---- FIM DA SEÇÃO DE LOGIN ----
        
        // ---- CÓDIGO DO APLICATIVO PRINCIPAL ----
        const rawDataTextarea = document.getElementById('rawData');
        const analyzeFieldsButton = document.getElementById('analyzeFieldsButton');
        const fieldsSelectionSection = document.getElementById('fieldsSelectionSection');
        const fieldsCheckboxesContainer = document.getElementById('fieldsCheckboxesContainer');
        const selectAllFieldsButton = document.getElementById('selectAllFields');
        const deselectAllFieldsButton = document.getElementById('deselectAllFields');
        const ratiosSection = document.getElementById
